<script>
const $ = (id)=>document.getElementById(id);
const ok = $("ok"), err = $("err");

function show(el, text){ el.textContent = text; el.style.display = "block"; }
function hideAll(){ ok.style.display = "none"; err.style.display = "none"; }

async function call(mode){
  hideAll();
  const email = $("email").value.trim();
  const password = $("password").value;
  if(!email || !password){ show(err, "Enter email and password."); return; }

  try{
    const res = await fetch("/api/signin", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ mode, email, password })
    });

    let data = {};
    try { data = await res.clone().json(); } catch {}
    const msg = (data && data.error) ? data.error : `HTTP ${res.status} ${res.statusText||""}`.trim();

    if(!res.ok || !data.ok){
      if(data.reason === "unverified" && data.resent){
        show(ok, "Email not confirmed. A new confirmation email has been sent â€” please check your inbox.");
      } else {
        show(err, msg);
      }
      return;
    }

    show(ok, mode === "create" ? "Account created. Check your email to confirm." : "Signed in!");
    if(data.redirect) location.href = data.redirect;
  }catch(e){
    show(err, e.message || "Network error.");
  }
}

$("signin").addEventListener("click", ()=>call("login"));
$("create").addEventListener("click", ()=>call("create"));
</script>
